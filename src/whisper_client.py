from pathlib import Path
from typing import Optional
from openai import OpenAI

from utils import normalize_text_simple


class WhisperClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Whisper API."""
    
    def __init__(self, api_url: str, api_key: str, model_name: str = "stt"):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ Whisper.
        
        Args:
            api_url: URL API —Å–µ—Ä–≤–µ—Ä–∞
            api_key: API –∫–ª—é—á
            model_name: –ò–º—è –º–æ–¥–µ–ª–∏ Whisper
        """
        self.client = OpenAI(api_key=api_key, base_url=api_url)
        self.model_name = model_name
    
    def transcribe(self, audio_file_path: Path) -> str:
        """
        –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ —Ñ–∞–π–ª.
        
        Args:
            audio_file_path: –ü—É—Ç—å –∫ –∞—É–¥–∏–æ —Ñ–∞–π–ª—É (FLAC)
            
        Returns:
            str: –¢–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
            
        Raises:
            Exception: –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
        """
        with open(audio_file_path, "rb") as audio_file:
            transcription = self.client.audio.transcriptions.create(
                model=self.model_name,
                file=audio_file,
                response_format="json"
            )
        
        return transcription.text


class LLMNormalizer:
    """
    –ö–ª–∞—Å—Å –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ LLM.
    
    –ë—É–¥—É—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
    - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
    - –ü—É–Ω–∫—Ç—É–∞—Ü–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    - –£–¥–∞–ª–µ–Ω–∏–µ filler words (—ç–º, –Ω—É, —Ç–∏–ø–∞)
    - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
    """
    
    # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
    DEFAULT_SYSTEM_PROMPT = """
    –¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π —Ä–µ—á–∏.

    –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
    1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
    2. –†–∞—Å—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é
    3. –£–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–µ—Å–Ω—ã–π –º—É—Å–æ—Ä (—ç–º, –Ω—É, –≤–æ—Ç, —Ç–∏–ø–∞, –∫–∞–∫ –±—ã)
    4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–º—ã—Å–ª –∏ —Å—Ç–∏–ª—å –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
    5. –†–∞–∑–±–∏—Ç—å –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

    –ü—Ä–∞–≤–∏–ª–∞:
    - –ù–ï –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç —Å–µ–±—è
    - –ù–ï –º–µ–Ω—è–π —Ç–µ—Ä–º–∏–Ω—ã –∏ –∏–º–µ–Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ
    - –°–æ—Ö—Ä–∞–Ω—è–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Ä–µ—á–∏
    - –í—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π
    """

    def __init__(
        self,
        api_url: str,
        api_key: str,
        model_name: str = "llm",
        system_prompt: Optional[str] = None
    ):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä–∞.
        
        Args:
            api_url: URL API —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–æ—Ç –∂–µ —á—Ç–æ –∏ –¥–ª—è Whisper)
            api_key: API –∫–ª—é—á
            model_name: –ò–º—è LLM –º–æ–¥–µ–ª–∏
            system_prompt: –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        """
        self.client = OpenAI(api_key=api_key, base_url=api_url)
        self.model_name = model_name
        self.system_prompt = system_prompt or self.DEFAULT_SYSTEM_PROMPT
    
    def normalize(self, raw_text: str) -> str:
        """
        –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ LLM.
        
        Args:
            raw_text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç Whisper
            
        Returns:
            str: –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            
        Raises:
            Exception: –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        """
        try:
            response = self.client.chat.completions.create(
                model=self.model_name,
                messages=[
                    {"role": "system", "content": self.system_prompt},
                    {"role": "user", "content": raw_text}
                ],
                temperature=0.3,  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                max_tokens=2000
            )
            
            normalized = response.choices[0].message.content.strip()
            return normalized
            
        except Exception as e:
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é
            print(f"‚ö†Ô∏è  LLM –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}")
            print("   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è")
            return normalize_text_simple(raw_text)
    
    def set_system_prompt(self, prompt: str) -> None:
        """
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç.
        
        Args:
            prompt: –ù–æ–≤—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        """
        self.system_prompt = prompt


class TranscriptionService:
    """
    –°–µ—Ä–≤–∏—Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π LLM –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π.
    
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç Whisper –∏ LLM –≤ –µ–¥–∏–Ω—ã–π pipeline.
    """
    
    def __init__(
        self,
        whisper_client: WhisperClient,
        llm_normalizer: Optional[LLMNormalizer] = None
    ):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞.
        
        Args:
            whisper_client: –ö–ª–∏–µ–Ω—Ç Whisper
            llm_normalizer: LLM –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        """
        self.whisper = whisper_client
        self.llm = llm_normalizer
    
    def process(self, audio_file_path: Path) -> tuple[str, Optional[str]]:
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞—É–¥–∏–æ —Ñ–∞–π–ª: —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è.
        
        Args:
            audio_file_path: –ü—É—Ç—å –∫ –∞—É–¥–∏–æ —Ñ–∞–π–ª—É
            
        Returns:
            tuple: (raw_text, normalized_text)
                   normalized_text –±—É–¥–µ—Ç None –µ—Å–ª–∏ LLM –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        """
        # –®–∞–≥ 1: –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —á–µ—Ä–µ–∑ Whisper
        print("üöÄ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —á–µ—Ä–µ–∑ Whisper...")
        raw_text = self.whisper.transcribe(audio_file_path)
        
        # –®–∞–≥ 2: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ LLM (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞)
        normalized_text = None
        if self.llm is not None:
            print("ü§ñ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ LLM...")
            normalized_text = self.llm.normalize(raw_text)
        else:
            # –ü—Ä–æ—Å—Ç–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
            normalized_text = normalize_text_simple(raw_text)
        
        return raw_text, normalized_text


# –ü—Ä–∏–º–µ—Ä—ã –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á

PODCAST_PROMPT = """–¢—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—à—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –ø–æ–¥–∫–∞—Å—Ç–∞.

–ó–∞–¥–∞—á–∏:
1. –ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
2. –†–∞—Å—Å—Ç–∞–≤—å –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é
3. –£–¥–∞–ª–∏ –º–µ–∂–¥–æ–º–µ—Ç–∏—è –∏ –ø–∞—É–∑—ã (—ç–º, –º–º, –Ω—É –≤–æ—Ç)
4. –°–æ—Ö—Ä–∞–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å
5. –†–∞–∑–±–µ–π –Ω–∞ –∞–±–∑–∞—Ü—ã –ø–æ —Å–º—ã—Å–ª–æ–≤—ã–º –±–ª–æ–∫–∞–º

–í—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç."""

AUDIOBOOK_PROMPT = """–¢—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—à—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –∞—É–¥–∏–æ–∫–Ω–∏–≥–∏.

–ó–∞–¥–∞—á–∏:
1. –ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
2. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è –∏ –∫–∞–≤—ã—á–∫–∏ –≤ –¥–∏–∞–ª–æ–≥–∞—Ö
3. –°–æ—Ö—Ä–∞–Ω–∏ –∞–≤—Ç–æ—Ä—Å–∫–∏–π —Å—Ç–∏–ª—å
4. –†–∞–∑–±–µ–π –Ω–∞ –∞–±–∑–∞—Ü—ã
5. –ù–ï —É–¥–∞–ª—è–π –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã

–í—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç."""

LECTURE_PROMPT = """–¢—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—à—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –ª–µ–∫—Ü–∏–∏.

–ó–∞–¥–∞—á–∏:
1. –ò—Å–ø—Ä–∞–≤—å —Ç–µ—Ä–º–∏–Ω—ã –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –ª–µ–∫—Å–∏–∫—É
2. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –ø–æ —Ç–µ–∑–∏—Å–∞–º
3. –£–¥–∞–ª–∏ –ø–æ–≤—Ç–æ—Ä—ã –∏ —Ä–µ—á–µ–≤–æ–π –º—É—Å–æ—Ä
4. –°–æ—Ö—Ä–∞–Ω–∏ –≤–∞–∂–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
5. –î–æ–±–∞–≤—å —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —Å–º—ã—Å–ª–æ–≤—ã–µ –±–ª–æ–∫–∏

–í—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç."""
